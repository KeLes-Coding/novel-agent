# test/simulate_pipeline.py
import sys
import os
import shutil
import yaml

# å°† src åŠ å…¥è·¯å¾„
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "../src")))

from core.manager import ProjectManager
from providers.base import LLMResult


# === 1. å®šä¹‰ Mock Provider ===
class MockProvider:
    """
    æ¨¡æ‹Ÿ LLM è¡Œä¸ºï¼Œä¸æ¶ˆè€— Tokenã€‚
    æ ¹æ® Prompt ä¸­çš„å…³é”®è¯è¿”å›ä¸åŒæ ¼å¼çš„æ•°æ®ï¼Œä»¥éª—è¿‡ Pipeline çš„è§£æé€»è¾‘ã€‚
    """

    def generate(self, system: str, prompt: str, **kwargs) -> LLMResult:
        # 1. é’ˆå¯¹ Step 01 Ideation (Layer 1 JSON)
        # å…³é”®è¯åŒ¹é… prompts.yaml ä¸­çš„ "æ„æ€ {{ num_ideas }} ä¸ª... è¯·è¾“å‡ºä¸€ä¸ªçº¯ JSON åˆ—è¡¨"
        if "æ„æ€" in prompt and "JSON" in prompt:
            # è¿”å›ç¬¦åˆ Step 01 è§£æè¦æ±‚çš„ JSON åˆ—è¡¨
            return LLMResult(
                text='[{"title": "Mock Book", "core_concept": "Test Concept"}]'
            )

        # 2. é’ˆå¯¹ Step 02 Outline (Layer 1 Structure JSON)
        if "åˆ†å·è§„åˆ’" in prompt:
            return LLMResult(
                text='[{"volume_id": 1, "title": "Mock Vol 1", "summary": "Summary 1"}]'
            )

        # 3. é’ˆå¯¹ Step 03 Bible (Layer 1 Extraction JSON)
        if "æå–å‡ºéœ€è¦è¿›è¡Œè¯¦ç»†è®¾å®šçš„æ¸…å•" in prompt:
            return LLMResult(
                text='{"characters": ["CharA"], "factions": ["FactionB"], "locations": ["LocC"], "system": ["SysD"]}'
            )

        # 4. é’ˆå¯¹ Step 04a Scene Plan (Layer 1 Extraction JSON)
        if "åˆ†åœº/ç« èŠ‚æ¸…å•" in prompt:
            return LLMResult(
                text='[{"id": 1, "title": "Scene 1", "summary": "Scene Summary", "characters": ["CharA"]}]'
            )

        # 5. é’ˆå¯¹ Evaluation/Analysis (Markdown Report)
        if "è¯„ä¼°æŠ¥å‘Š" in prompt or "åˆ†æ" in prompt:
            return LLMResult(text="# Mock Analysis Report\n\n- Risk: Low\n- Score: 90")

        # é»˜è®¤ï¼šè¿”å› Markdown æ–‡æœ¬ (ç”¨äº Expansion/Drafting)
        return LLMResult(
            text="# Mock Content\n\nThis is generated by MockProvider.\nSome dummy content for testing."
        )

    def stream_generate(self, system: str, prompt: str, **kwargs):
        # === æ ¸å¿ƒä¿®å¤ ===
        # å¤ç”¨ generate çš„é€»è¾‘æ¥è·å–æ­£ç¡®æ ¼å¼çš„æ–‡æœ¬ (JSON æˆ– Markdown)
        full_result = self.generate(system, prompt, **kwargs)
        full_text = full_result.text

        # æ¨¡æ‹Ÿæµå¼ï¼šå°†å®Œæ•´æ–‡æœ¬åˆ‡ç‰‡è¿”å›
        chunk_size = 5  # æ¯æ¬¡è¿”å› 5 ä¸ªå­—ç¬¦
        for i in range(0, len(full_text), chunk_size):
            yield full_text[i : i + chunk_size]


# === 2. æ¨¡æ‹Ÿè¿è¡Œ ===
def run_simulation():
    print("ğŸš€ Starting Pipeline Simulation (Dry Run)...")

    # åˆ›å»ºä¸´æ—¶é…ç½®
    test_run_dir = "runs/test_simulation"
    if os.path.exists(test_run_dir):
        try:
            shutil.rmtree(test_run_dir)
        except Exception as e:
            print(f"Warning: Could not clean up {test_run_dir}: {e}")

    config_path = "config/config.yaml"
    if not os.path.exists(config_path):
        config_path = "config/config_template.yaml"
        if not os.path.exists(config_path):
            print("âŒ Config not found, skipping.")
            return

    # åˆå§‹åŒ– Manager
    manager = ProjectManager(config_path)
    # å¼ºåˆ¶æ›¿æ¢ä¸º Mock Provider
    manager.provider = MockProvider()

    # å¼ºåˆ¶è¦†ç›–é…ç½®ï¼šå…³é—­ HITL äº¤äº’æ¨¡å¼ï¼Œé¿å…æµ‹è¯•é˜»å¡
    manager.config["workflow"] = {
        "interactive": False,
        "branching": {"enabled": True, "num_candidates": 1},
    }

    # å¼ºåˆ¶ä¿®æ”¹è¾“å‡ºç›®å½•
    manager.run_dir = test_run_dir
    os.makedirs(manager.run_dir, exist_ok=True)
    manager.store.root_dir = test_run_dir
    manager.state.run_dir = test_run_dir
    manager.state.save()

    print(f"ğŸ“‚ Run ID: {manager.run_id} (Mocked)")
    print(f"ğŸ“‚ Output Dir: {test_run_dir}")

    try:
        # Step 1: Ideation
        print("\n[1/5] Running Ideation...")
        manager.run_ideation()

        # Step 2: Outline
        print("\n[2/5] Running Outline...")
        manager.run_outline()

        # Step 3: Bible
        print("\n[3/5] Running Bible...")
        manager.run_bible()

        # Step 4a: Scene Plan
        print("\n[4/5] Running Scene Plan...")
        manager.init_scenes()

        # Step 4b: Drafting
        print("\n[5/5] Running Drafting...")
        manager.run_drafting_loop()

        print("\nâœ… Simulation Completed Successfully!")
        print(f"Check outputs in: {manager.run_dir}")

    except Exception as e:
        print(f"\nâŒ Simulation Failed: {e}")
        import traceback

        traceback.print_exc()


if __name__ == "__main__":
    run_simulation()
